---
title: "p2-ggmap"
author: "Yingbin Jiang"
date: "9/28/2017"
output: html_document
---
```{r, message=FALSE, warning=FALSE}
library(ggmap)
library(ggplot2)
library(leaflet)
library(htmltools)
library(dplyr)
library(plyr)
library(httr)
library(reshape2)
library(purrr)
```


#Set input information 
```{r}
#Input Variables
in_mile = 0.2 
from = 'Time Square,NYC,NY, USA'
to = 'Columbia University, NYC, NY, USA'

```

#Obtain transit location information and general nearby restaurant information 
```{r, message=FALSE}
route_df <- route(from, to, structure = 'route', mode = 'transit',output = "simple")# transit

for (i in 1:dim(route_df)[1]){
  route_df$address[i] = revgeocode(c(as.numeric(route_df$lon[i]),as.numeric(route_df$lat[i])))
  route_df$url[i]=paste0("https://www.yelp.com/search?f&find_loc=",gsub('\\s',"+",  route_df$address[i]),"&ns=1",sep="")
  route_df$content[i] = paste(sep = "<br/>",
  "<b><a href=route_df$url[i]</a></b>",
  route_df$address[i])
}
```

#Obtain detailed restaurant information
```{r yelp api}
#use yelp api we need to change it because for some reasons spa and salesman come in. remove them out
res = POST("https://api.yelp.com/oauth2/token",
            body = list(grant_type = "client_credentials",
            client_id = "KjjqVxt9pcpH6fWmEqVvEQ",
            client_secret = "ApFCYwJTIteL7mu146tmmLMuCui7unn2dcKN3ScFTrSLRLm8QWKNqkTWXtHz4OY1"))
token = content(res)$access_token
yelp = "https://api.yelp.com"

 # create an empty ctb dataframe
ctb = data.frame(matrix(NA, nrow = 0, ncol = 13))

# a for loop for 4 locations in this case 
for (i in 1:nrow(route_df)){
  url_i =modify_url(yelp, path = c("v3", "businesses", "search"),
               query = list(latitude =route_df$lat[i],longitude = route_df$lon[i],
                            open_now = T,
                            radius =round(1609*in_mile,0)))
  res_i = GET(url_i, add_headers('Authorization' = paste("bearer", token)))
  #http_status(res)
  ctb_list_i = content(res_i)$businesses
  ctb_i=data.frame(matrix(NA, nrow = 0, ncol = 13))
  for (j in 1:length(ctb_list_i)){ # create a J row dataframe
    ctb_i[j,1] = ctb_list_i[[j]]$id
    ctb_i[j,2] = ctb_list_i[[j]]$name
    ctb_i[j,3] = ctb_list_i[[j]]$image_url
    ctb_i[j,4] = ctb_list_i[[j]]$url
    ctb_i[j,5] = ctb_list_i[[j]]$review_count
    ctb_i[j,6] = ctb_list_i[[j]]$rating
    ctb_i[j,7] = ifelse (is.null(ctb_list_i[[j]]$price),NA,ctb_list_i[[j]]$price)
    ctb_i[j,8] = ctb_list_i[[j]]$display_phone
    ctb_i[j,9] = ctb_list_i[[j]]$coordinates$latitude
    ctb_i[j,10] = ctb_list_i[[j]]$coordinates$longitude
    ctb_i[j,11] = ctb_list_i[[j]]$location$display_address[[1]]
    ctb_i[j,12] = ctb_list_i[[j]]$location$zip_code
    ctb_i[j,13] = i 
  }
  ctb=rbind(ctb, ctb_i)
}

colnames(ctb) = c("id","name","image_url","url","review_count","rating","price","display_phone","latitude","longitude","address","zip code","stop")

ctb$price = factor(ctb$price)
```


#Visualization
```{r leaflet}
# the key part leaflet
factpal = colorFactor(rainbow(5), ctb$price)

leaflet(route_df) %>% addTiles() %>%
  addMarkers(~lon, ~lat, popup = ~htmlEscape(address))%>%
  addCircles(lng = ~lon, lat = ~lat, weight = 1,radius =1609*in_mile)%>%
  addPolylines(~lon, ~lat,color="red")%>%
  addCircleMarkers(ctb$longitude, ctb$latitude, radius = ctb$rating, stroke = FALSE, 
                   fillOpacity = ((ctb$review_count - min(ctb$review_count)) / max(ctb$review_count - min(ctb$review_count)))+0.4,
                   color = factpal(ctb$price), 
                   popup = paste( paste0("<b><a href=", "'",ctb$url,"'>", ctb$name, "</a></b>"),"<br>",
                               "Address :",ctb$address,"<br>",
                           paste0("Phone: ", "<b><a href=tel:", "'",ctb$display_phone,"'>", ctb$display_phone, "</a></b>"),"<br>",
                               "Rating:", ctb$rating, "<br>"
                               ))%>%
  addLegend(pal = factpal, values = ctb$price,
      title = "Price Range",
      opacity = 1
    )
```






```{r}
#critical part for google map useless code now
df2=route(from, to, structure = 'route', mode = 'transit',output = "all")
df2$routes[[1]]$legs[[1]]$steps[[1]]$html_instructions
df2$routes[[1]]$legs[[1]]$steps[[3]]$steps[[3]]$html_instructions
df2$routes[[1]]$legs[[1]]$steps[[3]]$steps[[1]]$travel_mode
df2$routes[[1]]$legs[[1]]$steps[[3]]$html_instructions
df2$routes[[1]]$legs[[1]]$steps[[1]]$html_instructions

df2$routes[[1]]$legs[[1]]$steps[[1]]$steps[[4]]$end_location$lat
  
route_df

df2$routes[[1]]$legs[[1]]$steps[[2]]$html_instructions
df2$routes[[1]]$legs[[1]]$steps[[3]]$html_instructions


```



